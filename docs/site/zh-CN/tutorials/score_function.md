# 搜索评分函数
### 为什么需要搜索评分函数
1. 检测类型的 Operator 接受一张图片，检测出来的是一组图片，这组图片的个数是不确定的。因此一张图片经过包含检测 Operator 的 Pipeline 的处理，结果是数目不确定的特征向量。
如何在这些向量的最近邻搜索结果中筛选出最符合需求的一组结果，需要有特定的评分机制的支持。

2. Phantoscope 0.2.0 之后支持了多 Pipeline 的支持，如何根据多个 field 的搜索结果筛选出最符合需求的一组结果，需要有特定的评分机制的支持。

### 搜索评分函数设置选项
1. Field 内评分模式（Inner Field Score Mode）

    针对一个 Application 中单个字段中数目不定的几组搜索结果，Phantoscope 提供了 InnerFieldScoreMode 支持个性化的方式筛选最终结果。
    目前支持的几种模式如下所示：
        
    | inner field score mode | 解释                                                                                     | 备注                                                       |
    | ---------------------- | ------------------------------------------------------------------------------------------ | ------------------------------------------------------------ |
    | first                  | 从单 fields 中的检测出的若干个实体中选取第一个实体，进行 topk 搜索。 | 一般检测出的实体是按置信度排序，第一个也就是置信度最高的。 |
    | avg-select             | 对从单 fields 中的检测出的若干个实体进行topk 搜索， 从结果集中平均选取前几个作为最终搜索结果。 | 平均选取，保证搜索的结果集中各种实体都会出现。 |
    | random-select          | 从单 fields 中的检测出的若干个实体中随机选取一个实体，进行 topk 搜索。 | 随机选取，以增加搜索的多样性。                   |
    | distance_first         | 从单 fields 中的检测出的若干个实体进行topk 搜索， 从结果集中选取距离最近的作为最终搜索结果。 | 选取距离最近的，结果会保证都是和输入图片中某一个部分最相近的。 |
    
    以一个物体检测的实例作为说明， 一张特定的图片作为搜索数据，Phantoscope 首先使用 Processor (这里特指 detector类，如 SSD) 提取出图片中的一张桌子、一把椅子和一个台灯，接下来将这三张图片经过 Encoder 编码后，会得到三个特征向量，每个向量都会作为输入，在 Milvus 中找到最近似的 topk 个实体。
    如果指定 `distance_first` 的 Field 内评分模式，则会对所有搜索结果根据向量距离进行排序，选出距离最小的作为最终结果。这时候得到的结果一定是与搜索图像中某个物体最相似的结果集。
    
    
2. Field 间评分模式（Score Mode）

    针对一个 Application 中多个字段的搜索结果， Phantoscope 提供了 ScoreMode 支持个性化地组合各个字段的搜索结果，并将最终得分排序选出得分最高的作为最终结果。
    目前支持的几种模式如下所示：
    
    | score mode | 解释                            | 备注 |
    | ---------- | --------------------------------- | ---- |
    | first      | 选取第一个field的得分作为最终得分 |      |
    | sum        | 求和所有field的得分作为最终得分 |      |
    | max        | 所有field中最高得分作为最终得分 |      |
    | min        | 所有field中最低得分作为最终得分 |      |
    | multiple   | 求积所有field的得分作为最终得分 |      |
    | avg        | 求平均所有field的得分作为最终得分 |      |

3. 搜索评分函数 （Score Function）
    
    1. weight
    
        指定特定字段的权重，以改变该字段结果对最终结果的影响。
    
    2. decay functions: 线性
    
        特定字段内搜索结果根据默认排序，衰减对应的得分。目前只实现线性衰减。